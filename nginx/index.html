<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MegaChat 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; display: flex; height: 100vh;
            background-color: #0f0f0f; color: #ffffff; overflow: hidden;
        }

        .sidebar {
            width: 300px; background-color: #212121;
            border-right: 1px solid #2f2f2f; display: flex; flex-direction: column;
        }

        .sidebar-header { padding: 15px; background-color: #2c2c2c; display: flex; justify-content: space-between; align-items: center; }
        
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item {
            padding: 15px; cursor: pointer; border-bottom: 1px solid #2f2f2f;
            display: flex; align-items: center; transition: 0.2s;
        }
        .chat-item:hover { background-color: #2b2b2b; }
        .chat-item.active { background-color: #40a7e3; }

        .chat-area {
            flex: 1; display: flex; flex-direction: column;
            background: rgba(15, 15, 15, 0.9); position: relative;
        }

        .messages {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px; z-index: 1;
        }

        .message {
            max-width: 60%; padding: 10px 15px; border-radius: 10px;
            background-color: #212121; align-self: flex-start; line-height: 1.4;
        }
        .message.sent { background-color: #40a7e3; align-self: flex-end; }
        .message img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }

        .input-area {
            padding: 15px; background-color: #212121;
            display: flex; align-items: center; gap: 10px;
        }
        .input-area input[type="text"] {
            flex: 1; padding: 12px; border-radius: 20px;
            border: 1px solid #333; background: #0f0f0f; color: white;
        }

        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0f0f; z-index: 1000; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
        }
        #login-screen input { padding: 10px; margin: 5px; width: 250px; background: #212121; border: 1px solid #333; color: white; }
        #login-screen button { padding: 10px 20px; background: #40a7e3; border: none; color: white; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>MegaChat Login</h2>
        <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω (username)">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <p id="login-error" style="color: red; display: none; margin-top: 10px;"></p>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h3>–ß–∞—Ç—ã</h3>
            <button onclick="logout()" title="–í—ã–π—Ç–∏" style="background:none; border:none; color: #888; cursor:pointer;">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        <div class="chat-list" id="chat-list">
            </div>
    </div>

    <div class="chat-area">
        <div id="chat-header" style="padding: 15px; background: #212121; border-bottom: 1px solid #2f2f2f;">
            <span id="chat-title" style="font-weight: bold;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
            <small id="chat-status" style="margin-left: 10px;"></small>
        </div>

        <div class="messages" id="messages-container"></div>

        <div class="input-area">
            <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; color:#aaa; cursor:pointer; font-size: 1.2rem;">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="file-input" style="display:none" onchange="uploadFile()">
            <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="background:none; border:none; color:#40a7e3; cursor:pointer; font-size: 1.2rem;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://my-super-chat-2026.loca.lt/'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –∞–¥—Ä–µ—Å —Ç—É–Ω–Ω–µ–ª—è
        const WS_BASE = window.location.protocol === 'https:' ? 'wss://' + window.location.host : 'ws://' + window.location.host;

        let accessToken = localStorage.getItem('access_token');
        let activeChatId = null;
        let socket = null;

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –∑–∞–≥–ª—É—à–∫–∏ Localtunnel
        const getHeaders = () => ({
            'Content-Type': 'application/json',
            'Bypass-Tunnel-Reminder': 'true',
            ...(accessToken ? { 'Authorization': `Bearer ${accessToken}` } : {})
        });

        async function login() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');

            try {
                const res = await fetch(`${API_BASE}/api/auth/login/`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // –í–û–¢ –≠–¢–û–¢ –ó–ê–ì–û–õ–û–í–û–ö –†–ï–®–ê–ï–¢ –ü–†–û–ë–õ–ï–ú–£:
                        'Bypass-Tunnel-Reminder': 'true' 
                    },
                    body: JSON.stringify({ username: user, password: pass })
                });

                // –¢–µ–ø–µ—Ä—å Localtunnel –ø—Ä–æ–ø—É—Å—Ç–∏—Ç –∑–∞–ø—Ä–æ—Å –∫ Django
                const data = await res.json();
                
                if (res.ok) {
                    accessToken = data.access;
                    localStorage.setItem('access_token', accessToken);
                    document.getElementById('login-screen').style.display = 'none';
                    initApp();
                } else {
                    errorEl.innerText = data.detail || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                console.error("Fetch error:", e);
                errorEl.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ (–ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å)";
                errorEl.style.display = 'block';
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function initApp() {
            loadChats();
            connectWebSocket();
        }

        async function loadChats() {
            try {
                const res = await fetch(`${API_BASE}/api/chats/`, { headers: getHeaders() });
                const chats = await res.json();
                const list = document.getElementById('chat-list');
                list.innerHTML = '';
                chats.forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `chat-item ${chat.id === activeChatId ? 'active' : ''}`;
                    div.innerHTML = `<strong>${chat.title || '–ß–∞—Ç ' + chat.id}</strong>`;
                    div.onclick = () => openChat(chat);
                    list.appendChild(div);
                });
            } catch (e) { console.error("–û—à–∏–±–∫–∞ —á–∞—Ç–æ–≤:", e); }
        }

        async function openChat(chat) {
            activeChatId = chat.id;
            document.getElementById('chat-title').innerText = chat.title || `–ß–∞—Ç #${chat.id}`;
            document.getElementById('messages-container').innerHTML = '';
            loadChats();

            try {
                const res = await fetch(`${API_BASE}/api/chats/${chat.id}/messages/`, { headers: getHeaders() });
                const messages = await res.json();
                messages.forEach(appendMessage);
                scrollToBottom();
            } catch (e) { console.error("–û—à–∏–±–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏:", e); }
        }

        async function uploadFile() {
            const file = document.getElementById('file-input').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                // –ü—É—Ç—å —Å–æ–≥–ª–∞—Å–Ω–æ Nginx: /media-api/
                const res = await fetch(`${API_BASE}/media-api/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Bypass-Tunnel-Reminder': 'true' },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const fileUrl = `${API_BASE}/media-api/media/${data.saved_as}`;
                    sendMessage(null, fileUrl);
                }
            } catch (e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞"); }
        }

        function sendMessage(text = null, fileUrl = null) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            const input = document.getElementById('message-input');
            const msgText = text || input.value;
            if (!msgText && !fileUrl) return;

            socket.send(JSON.stringify({
                message: msgText,
                file_url: fileUrl,
                chat_id: activeChatId
            }));
            input.value = '';
        }

        function connectWebSocket() {
            socket = new WebSocket(`${WS_BASE}/ws/?token=${accessToken}`);
            socket.onopen = () => document.getElementById('chat-status').innerText = "üì° –û–Ω–ª–∞–π–Ω";
            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.chat_id == activeChatId) {
                    appendMessage(data);
                    scrollToBottom();
                }
            };
            socket.onclose = () => {
                document.getElementById('chat-status').innerText = "üî¥ –û—Ñ—Ñ–ª–∞–π–Ω (—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç...)";
                setTimeout(connectWebSocket, 3000);
            };
        }

        function appendMessage(msg) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            div.className = `message`; 

            let html = '';
            if (msg.file_url) html += `<a href="${msg.file_url}" target="_blank"><img src="${msg.file_url}"></a>`;
            if (msg.text || msg.message) html += `<p>${msg.text || msg.message}</p>`;
            
            div.innerHTML = html;
            container.appendChild(div);
        }

        function scrollToBottom() {
            const c = document.getElementById('messages-container');
            c.scrollTop = c.scrollHeight;
        }

        if (accessToken) initApp();
    </script>
</body>
</html>