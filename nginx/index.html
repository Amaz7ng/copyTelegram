<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microservice Chat Debugger</title>
    <style>
        :root {
            --bg: #0d1117; --panel: #161b22; --border: #30363d;
            --text: #c9d1d9; --accent: #238636; --error: #f85149;
        }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        
        /* –°–µ—Ç–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 100; }
        #app-screen { display: none; width: 100%; height: 100%; }
        
        #side-bar { width: 300px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--panel); }
        #chat-window { flex-grow: 1; display: flex; flex-direction: column; }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã */
        .card { background: var(--panel); padding: 20px; border-radius: 6px; border: 1px solid var(--border); width: 300px; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid var(--border); background: #010409; color: white; box-sizing: border-box;}
        button { background: var(--accent); cursor: pointer; font-weight: bold; border: none; }
        button:hover { opacity: 0.8; }
        
        #chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .chat-item:hover { background: #21262d; }
        
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 70%; padding: 10px; border-radius: 8px; background: #21262d; align-self: flex-start; }
        .msg.me { align-self: flex-end; background: #23863644; border: 1px solid var(--accent); }
        
        .status-bar { padding: 5px 10px; font-size: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .unread-badge { background: var(--error); border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px; }
        
        #controls { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        #file-preview { font-size: 12px; color: #8b949e; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card" id="login-form">
            <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="handleAuth('login')">–í–æ–π—Ç–∏</button>
            <button style="background: #30363d" onclick="handleAuth('register')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <div id="otp-area" style="display:none; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px;">
                <input type="text" id="otp-code" placeholder="OTP –ö–æ–¥">
                <button onclick="verifyOtp()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å 2FA</button>
            </div>
        </div>
    </div>

    <div id="app-screen">
        <div id="side-bar">
            <div class="status-bar">
                <span id="user-display"></span>
                <span id="global-unread">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: 0</span>
            </div>
            
            <div style="padding: 10px; padding-bottom: 0;">
                <input type="text" id="search-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." onkeyup="searchUsers(this.value)">
                <div id="search-results" style="position: absolute; background: var(--panel); width: 280px; z-index: 10;"></div>
            </div>

            <div style="display: flex; gap: 5px; padding: 10px;">
                <button onclick="createNewChat('group')" style="font-size: 11px; margin: 0;">+ –ì—Ä—É–ø–ø–∞</button>
                <button onclick="createNewChat('channel')" style="font-size: 11px; background: #8957e5; margin: 0;">+ –ö–∞–Ω–∞–ª</button>
            </div>

            <div id="chat-list">
                </div>
        </div>

        <div id="chat-window">
            <div class="status-bar" id="current-chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <div id="messages"></div>
            <div id="file-preview"></div>
            <div id="controls">
                <input type="file" id="file-input" style="display:none" onchange="updateFileLabel()">
                <button style="width: 40px;" onclick="document.getElementById('file-input').click()">üìé</button>
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button style="width: 80px;" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const RAW_HOST = 'wild-boats-stay.loca.lt'; 
        const API_BASE = `https://${RAW_HOST}`;

        let accessToken = null;
        let currentChatId = null;
        let mainWs = null;
        let currentUser = null;

        // --- AUTH LOGIC ---
        async function handleAuth(type) {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            
            const endpoint = type === 'login' ? '/api/auth/login/' : '/api/auth/register/';
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });
                const data = await res.json();

                if (data.message === "OTP_SENT") {
                    document.getElementById('otp-area').style.display = 'block';
                    alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ Django (–∏–º–∏—Ç–∞—Ü–∏—è SMS/Email)");
                } else if (data.access) {
                    saveAuth(data);
                } else if (type === 'register') {
                    alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
                } else {
                    alert("–û—à–∏–±–∫–∞: " + JSON.stringify(data));
                }
            } catch (e) { console.error(e); }
        }

        async function verifyOtp() {
            const user = document.getElementById('username').value;
            const code = document.getElementById('otp-code').value;
            const res = await fetch(`${API_BASE}/api/auth/verify-otp/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, otp_code: code })
            });
            const data = await res.json();
            if (data.access) saveAuth(data);
            else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥");
        }

        async function createNewChat(type) {
            const title = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è ${type === 'group' ? '–≥—Ä—É–ø–ø—ã' : '–∫–∞–Ω–∞–ª–∞'}:`);
            if (!title) return;

            try {
                const res = await fetch(`${API_BASE}/api/chats/`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ 
                        type: type, 
                        title: title 
                    })
                });

                if (res.ok) {
                    loadChats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
                } else {
                    const err = await res.json();
                    alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: " + JSON.stringify(err));
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞:", e);
            }
        }

        function saveAuth(data) {
            accessToken = data.access;
            currentUser = document.getElementById('username').value;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            document.getElementById('user-display').innerText = `–Ø: ${currentUser}`;
            initApp();
        }

// --- INITIALIZATION ---
        function initApp() {
            loadChats();
            setupGlobalSocket(); // –î–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–±–∞–¥–∂–µ–π)
        }

        // --- CHAT & USERS ---
        async function searchUsers(query) {
            if (query.length < 2) return;
            // –ü–æ–∏—Å–∫ –ø–æ search_handle (–∏–∑ —Ç–≤–æ–µ–π –º–æ–¥–µ–ª–∏ User)
            const res = await fetch(`${API_BASE}/api/auth/users/?search=${query}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const users = await res.json();
            const container = document.getElementById('search-results');
            container.innerHTML = users.map(u => `
                <div class="chat-item" onclick="startDirectChat(${u.id}, '${u.username}')">
                    ${u.username} (@${u.search_handle})
                </div>
            `).join('');
        }

        async function startDirectChat(userId, username) {
            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ª–∏—á–Ω—ã–π —á–∞—Ç —á–µ—Ä–µ–∑ —Ç–≤–æ–π MessageViewSet
            const res = await fetch(`${API_BASE}/api/messages/`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({ receiver_id: userId, text: "–ù–∞—á–∞–ª–æ —á–∞—Ç–∞" })
            });
            const data = await res.json();
            document.getElementById('search-results').innerHTML = '';
            loadChats();
            connectToChat(data.chat, username);
        }

        async function loadChats() {
            const res = await fetch(`${API_BASE}/api/chats/`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const chats = await res.json();
            const list = document.getElementById('chat-list');
            list.innerHTML = chats.map(c => `
                <div class="chat-item" onclick="connectToChat(${c.id}, '${c.title || c.interlocutor?.username}')">
                    ${c.title || c.interlocutor?.username || '–ß–∞—Ç ' + c.id}
                    <span id="badge-${c.id}" class="unread-badge ${c.unread_count ? '' : 'hidden'}">${c.unread_count || 0}</span>
                </div>
            `).join('');
        }

        // --- WEBSOCKET LOGIC ---
        function connectToChat(chatId, title) {
            currentChatId = chatId;
            document.getElementById('current-chat-title').innerText = title;
            document.getElementById('messages').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...';

            if (mainWs) mainWs.close();

            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL –¥–ª—è WebSocket
            const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
            
            // –í–ù–ò–ú–ê–ù–ò–ï: –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º RAW_HOST –±–µ–∑ https://
            mainWs = new WebSocket(`${wsScheme}://${RAW_HOST}/ws/chat/${chatId}/?token=${accessToken}`);

            mainWs.onmessage = (e) => {
                const data = JSON.parse(e.data);
                handleIncomingEvent(data);
            };

            loadMessages(chatId);
        }

        async function loadMessages(chatId) {
            const res = await fetch(`${API_BASE}/api/messages/?chat=${chatId}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const msgs = await res.json();
            const container = document.getElementById('messages');
            container.innerHTML = '';
            msgs.forEach(m => renderMessage(m));
            container.scrollTop = container.scrollHeight;
        }

        // --- MESSAGE SENDING (FETCH + MEDIA) ---
        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const fileInput = document.getElementById('file-input');
            const text = input.value;
            const file = fileInput.files[0];

            if (!text && !file) return;

            const formData = new FormData();
            formData.append('chat', currentChatId);
            if (text) formData.append('text', text);
            if (file) formData.append('file', file);

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ API (–∫–∞–∫ –≤ —Ç–≤–æ–µ–º views.py MessageViewSet.create)
                const res = await fetch(`${API_BASE}/api/messages/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                    body: formData
                });
                
                if (res.ok) {
                    input.value = '';
                    fileInput.value = '';
                    updateFileLabel();
                }
            } catch (e) { alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
        }

        function renderMessage(data) {
            const container = document.getElementById('messages');
            const isMe = data.sender_username === currentUser;
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${isMe ? 'me' : ''}`;
            
            let content = `<b>${data.sender_username || '–°–∏—Å—Ç–µ–º–∞'}:</b><br>${data.text || ''}`;
            
            if (data.file) {
                const fileUrl = data.file.startsWith('http') 
                    ? data.file 
                    : `${API_BASE}/api/media/${data.file}`;
                
                const isImage = data.file.match(/\.(jpg|jpeg|png|gif|webp)$/i);

                if (isImage) {
                    content += `
                        <div style="margin-top: 8px;">
                            <img src="${fileUrl}" 
                                style="max-width: 100%; border-radius: 8px;" 
                                onerror="this.style.display='none';">
                        </div>`;
                } else {
                    content += `<br><a href="${fileUrl}" target="_blank">üìé –§–∞–π–ª</a>`;
                }
            }
                        msgDiv.innerHTML = content;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleIncomingEvent(data) {
            if (data.type === 'chat_message') {
                renderMessage(data);
            } else if (data.type === 'unread_badge') {
                document.getElementById('global-unread').innerText = `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${data.unread_count}`;
            }
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 'edit_message' –∏ 'delete_message'
        }

        function updateFileLabel() {
            const file = document.getElementById('file-input').files[0];
            document.getElementById('file-preview').innerText = file ? `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}` : '';
        }

        function setupGlobalSocket() {
            // –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–æ–∫–µ—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–∏–∑ —Ç–≤–æ–µ–≥–æ routing.py)
            // const notifyWs = new WebSocket(`ws://${BASE_URL}/ws/notifications/?token=${accessToken}`);
        }
    </script>
</body>
</html>