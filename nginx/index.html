<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microservice Chat Debugger</title>
    <style>
        :root {
            --bg: #0d1117; --panel: #161b22; --border: #30363d;
            --text: #c9d1d9; --accent: #238636; --error: #f85149;
        }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        
        /* –°–µ—Ç–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 100; }
        #app-screen { display: none; width: 100%; height: 100%; }
        
        #side-bar { width: 300px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--panel); }
        #chat-window { flex-grow: 1; display: flex; flex-direction: column; }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã */
        .card { background: var(--panel); padding: 20px; border-radius: 6px; border: 1px solid var(--border); width: 300px; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid var(--border); background: #010409; color: white; box-sizing: border-box;}
        button { background: var(--accent); cursor: pointer; font-weight: bold; border: none; }
        button:hover { opacity: 0.8; }
        
        #chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .chat-item:hover { background: #21262d; }
        
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 70%; padding: 10px; border-radius: 8px; background: #21262d; align-self: flex-start; }
        .msg.me { align-self: flex-end; background: #23863644; border: 1px solid var(--accent); }
        
        .status-bar { padding: 5px 10px; font-size: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .unread-badge { background: var(--error); border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px; }
        
        #controls { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        #file-preview { font-size: 12px; color: #8b949e; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card" id="login-form">
            <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="handleAuth('login')">–í–æ–π—Ç–∏</button>
            <button style="background: #30363d" onclick="handleAuth('register')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <div id="otp-area" style="display:none; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px;">
                <input type="text" id="otp-code" placeholder="OTP –ö–æ–¥">
                <button onclick="verifyOtp()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å 2FA</button>
            </div>
        </div>
    </div>

    <div id="app-screen">
        <div id="side-bar">
            <div class="status-bar">
                <span id="user-display"></span>
                <span id="global-unread">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: 0</span>
            </div>
            
            <div style="padding: 10px; padding-bottom: 0;">
                <input type="text" id="search-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." onkeyup="searchUsers(this.value)">
                <div id="search-results" style="position: absolute; background: var(--panel); width: 280px; z-index: 10;"></div>
            </div>

            <div style="display: flex; gap: 5px; padding: 10px;">
                <button onclick="createNewChat('group')" style="font-size: 11px; margin: 0;">+ –ì—Ä—É–ø–ø–∞</button>
                <button onclick="createNewChat('channel')" style="font-size: 11px; background: #8957e5; margin: 0;">+ –ö–∞–Ω–∞–ª</button>
            </div>

            <div id="chat-list">
                </div>
        </div>

        <div id="chat-window">
            <div class="status-bar" id="current-chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <div id="messages"></div>
            <div id="file-preview"></div>
            <div id="controls">
                <input type="file" id="file-input" style="display:none" onchange="updateFileLabel()">
                <button style="width: 40px;" onclick="document.getElementById('file-input').click()">üìé</button>
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button style="width: 80px;" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const RAW_HOST = 'tame-pugs-like.loca.lt'; 
        const API_BASE = `https://${RAW_HOST}`;

        let accessToken = null;
        let currentChatId = null;
        let mainWs = null;
        let currentUser = null;

        // --- AUTH LOGIC ---
        async function handleAuth(type) {
            const userField = document.getElementById('username');
            const passField = document.getElementById('password');
            const user = userField.value.trim();
            const pass = passField.value.trim();

            if (!user || !pass) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å");
                return;
            }

            const endpoint = type === 'login' ? '/api/auth/login/' : '/api/auth/register/';
            
            const payload = { 
                username: user, 
                password: pass 
            };

            if (type === 'register') {
                payload.email = `${user}@example.com`; 
            }

            try {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    handleApiErrors(errorData);
                    return;
                }

                const data = await res.json();

                if (data.access) {
                    saveAuth(data);
                } else if (data.message === "OTP_SENT") {
                    document.getElementById('otp-area').style.display = 'block';
                    alert("–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
                } else if (type === 'register') {
                    alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.");
                }

            } catch (e) {
                console.error("Auth Error:", e);
                alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: " + e.message);
            }
        }

        function handleApiErrors(data) {
            let errorMsg = "";
            if (data.detail) {
                errorMsg = data.detail;
            } else {
                for (let key in data) {
                    errorMsg += `${key}: ${data[key].join(', ')}\n`;
                }
            }
            alert("–û—à–∏–±–∫–∞:\n" + (errorMsg || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"));
        }

        async function verifyOtp() {
            const user = document.getElementById('username').value;
            const code = document.getElementById('otp-code').value;
            const res = await fetch(`${API_BASE}/api/auth/verify-otp/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, otp_code: code })
            });
            const data = await res.json();
            if (data.access) saveAuth(data);
            else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥");
        }

        async function createNewChat(type) {
            const title = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è ${type === 'group' ? '–≥—Ä—É–ø–ø—ã' : '–∫–∞–Ω–∞–ª–∞'}:`);
            if (!title) return;

            try {
                const res = await fetch(`${API_BASE}/api/chats/`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ type: type, title: title })
                });

                if (res.ok) {
                    loadChats();
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è");
                }
            } catch (e) { console.error(e); }
        }

        function saveAuth(data) {
            accessToken = data.access;
            currentUser = document.getElementById('username').value;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            document.getElementById('user-display').innerText = `–Ø: ${currentUser}`;
            initApp();
        }

        function initApp() {
            loadChats();
        }

        // --- CHAT & USERS ---
        async function searchUsers(query) {
            const container = document.getElementById('search-results');
            if (query.length < 2) {
                container.innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/auth/users/?search=${query}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (!res.ok) return;
                
                const users = await res.json();
                container.innerHTML = users.map(u => `
                    <div class="chat-item" style="border: 1px solid var(--border); background: var(--panel);" 
                        onclick="startDirectChat(${u.id}, '${u.username}')">
                        ${u.username}
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function startDirectChat(userId, username) {
            const res = await fetch(`${API_BASE}/api/messages/`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({ receiver_id: userId, text: "–ù–∞—á–∞–ª–æ —á–∞—Ç–∞" })
            });
            const data = await res.json();
            document.getElementById('search-results').innerHTML = '';
            loadChats();
            // –í –æ—Ç–≤–µ—Ç–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç chat (id), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            connectToChat(data.chat, username);
        }

        async function loadChats() {
            const res = await fetch(`${API_BASE}/api/chats/`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const chats = await res.json();
            const list = document.getElementById('chat-list');
            list.innerHTML = chats.map(c => `
                <div class="chat-item" onclick="connectToChat(${c.id}, '${c.title || c.interlocutor?.username || '–ß–∞—Ç'}')">
                    ${c.title || c.interlocutor?.username || '–ß–∞—Ç ' + c.id}
                    <span id="badge-${c.id}" class="unread-badge ${c.unread_count ? '' : 'hidden'}">${c.unread_count || 0}</span>
                </div>
            `).join('');
        }

        // --- WEBSOCKET LOGIC ---
        function connectToChat(chatId, title) {
            currentChatId = chatId;
            document.getElementById('current-chat-title').innerText = title;
            
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '<div style="text-align:center; opacity:0.5;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';

            if (mainWs) {
                mainWs.close();
            }

            const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
            const cleanHost = RAW_HOST.replace(/\/$/, ""); 
            
            try {
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –Ω—É–∂–Ω–æ–º—É Chat ID
                mainWs = new WebSocket(`${wsScheme}://${cleanHost}/ws/chat/${chatId}/?token=${accessToken}`);

                mainWs.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    handleIncomingEvent(data);
                };

                mainWs.onerror = (e) => console.error("WebSocket Error:", e);
                
                loadMessages(chatId);
            } catch (err) {
                console.error("WS Connection failed:", err);
            }
        }

        async function loadMessages(chatId) {
            const res = await fetch(`${API_BASE}/api/messages/?chat=${chatId}`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const msgs = await res.json();
            const container = document.getElementById('messages');
            container.innerHTML = '';
            msgs.forEach(m => renderMessage(m));
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const fileInput = document.getElementById('file-input');
            const text = input.value;
            const file = fileInput.files[0];

            if (!text && !file) return;

            const formData = new FormData();
            formData.append('chat', currentChatId);
            if (text) formData.append('text', text);
            if (file) formData.append('file', file);

            try {
                const res = await fetch(`${API_BASE}/api/messages/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                    body: formData
                });
                
                if (res.ok) {
                    input.value = '';
                    fileInput.value = '';
                    updateFileLabel();
                    // –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–¥–µ—Ç —á–µ—Ä–µ–∑ WebSocket, –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –µ–≥–æ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
                }
            } catch (e) { alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
        }

        // --- FIXED IMAGE & DATA HANDLING ---
        function renderMessage(data) {
            const container = document.getElementById('messages');
            if (!container) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
            if (document.getElementById(`msg-${data.id}`)) return;

            const isMe = data.sender_username === currentUser;
            const msgDiv = document.createElement('div');
            msgDiv.id = `msg-${data.id}`; // –î–æ–±–∞–≤–ª—è–µ–º ID —ç–ª–µ–º–µ–Ω—Ç—É
            msgDiv.className = `msg ${isMe ? 'me' : ''}`;
            
            let textContent = data.text ? data.text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";

            let content = `
                <div style="font-size: 0.75em; color: #8b949e; margin-bottom: 4px;">
                    ${data.sender_username || 'User'}
                </div>
                <div>${textContent}</div>
            `;

            if (data.file) {
                // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–£–¢–ï–ô ---
                // –ë—ç–∫–µ–Ω–¥ —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –≤–∏–¥–∞ "/api/media/file.png"
                // –ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http, –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–º–µ–Ω
                let fileUrl = data.file;
                if (!fileUrl.startsWith('http')) {
                    // API_BASE —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç https://host, –∞ data.file –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /api
                    // –†–µ–∑—É–ª—å—Ç–∞—Ç: https://host/api/media/file.png
                    fileUrl = API_BASE + fileUrl;
                }
                
                // –î–ª—è –ø—Ä–µ–≤—å—é: –≤—ã—Ä–µ–∑–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø—É—Ç–∏
                // "/api/media/uuid.png" -> split -> ["", "api", "media", "uuid.png"] -> pop -> "uuid.png"
                const fileName = data.file.split('/').pop();
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ —Ç–∞–º–±–Ω–µ–π–ª—É. Thumb service –∂–¥–µ—Ç –ø—Ä–æ—Å—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞
                const thumbUrl = `${API_BASE}/api/thumbnails/thumb_${fileName}`;

                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(fileName);
                
                if (isImage) {
                    content += `
                        <div style="margin-top: 8px;">
                            <a href="${fileUrl}" target="_blank">
                                <img src="${thumbUrl}" 
                                    style="max-width: 200px; border-radius: 8px; border: 1px solid var(--border);"
                                    onerror="this.onerror=null; this.src='${fileUrl}';"> </a>
                        </div>`;
                } else {
                    content += `
                        <div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                            <a href="${fileUrl}" target="_blank" style="color: var(--accent);">
                                üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                            </a>
                        </div>`;
                }
            }

            msgDiv.innerHTML = content;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        // --- FIXED WS HANDLER ---
        function handleIncomingEvent(data) {
            console.log("WS Event:", data);

            if (data.type === 'chat_message') {
                // –í–ê–ñ–ù–û: –î–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ª–µ–∂–∞—Ç –≤–Ω—É—Ç—Ä–∏ –∫–ª—é—á–∞ 'message'
                const msgData = data.message;
                
                // –í–ê–ñ–ù–û: –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º ID —á–∞—Ç–∞ (msgData.chat) —Å —Ç–µ–∫—É—â–∏–º (currentChatId)
                if (String(msgData.chat) === String(currentChatId)) {
                    renderMessage(msgData);
                }
            } else if (data.type === 'unread_badge_update') {
                const chatBadge = document.getElementById(`badge-${data.chat_id}`);
                if (chatBadge) {
                    chatBadge.innerText = data.unread_count || '0';
                    chatBadge.style.display = data.unread_count > 0 ? 'inline-block' : 'none';
                }
            }
        }

        function updateFileLabel() {
            const file = document.getElementById('file-input').files[0];
            document.getElementById('file-preview').innerText = file ? `–í—ã–±—Ä–∞–Ω: ${file.name}` : '';
        }
    </script>
</body>
</html>